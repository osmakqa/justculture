<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Just Culture Assessment Tool — Ospital ng Makati</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --tab-gap:.5rem }
    @media print { .no-print{display:none!important} body{margin:12mm} .card{box-shadow:none!important;border:1px solid #ddd} }
    @media (max-width:1024px){
      .mobile-auto .grid-2{grid-template-columns:1fr!important}
      .mobile-auto .tabbar{grid-template-columns:repeat(6,minmax(7rem,1fr));overflow-x:auto;gap:var(--tab-gap);-webkit-overflow-scrolling:touch}
      .mobile-auto .tabbar .tab{white-space:nowrap}
      .mobile-auto .touch-pad>*{padding:.9rem 1rem!important;font-size:1rem}
      .mobile-auto .input-lg{padding:.75rem!important}
    }
    .mobile-forced .grid-2{grid-template-columns:1fr!important}
    .mobile-forced .tabbar{grid-template-columns:repeat(6,minmax(7rem,1fr));overflow-x:auto;gap:var(--tab-gap);-webkit-overflow-scrolling:touch}
    .mobile-forced .tabbar .tab{white-space:nowrap}
    .mobile-forced .touch-pad>*{padding:.9rem 1rem!important;font-size:1rem}
    .mobile-forced .input-lg{padding:.75rem!important}
    .desktop-forced .grid-2{grid-template-columns:1fr 1fr!important}
    .desktop-forced .tabbar{grid-template-columns:repeat(6,minmax(0,1fr));overflow:visible}
    .card{box-shadow:0 1px 2px rgba(0,0,0,.05)}
    #busyBar{position:fixed;top:10px;left:50%;transform:translateX(-50%);
      background:#065f46;color:#fff;padding:.5rem .75rem;border-radius:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.2);
      z-index:1000;display:none;font-size:.9rem}
    #busyBar[data-kind="error"]{background:#b91c1c}
    #busyBar[data-kind="info"]{background:#065f46}
  </style>
</head>
<body class="min-h-screen bg-neutral-50 text-neutral-900 mobile-auto" id="appRoot">
  <div id="busyBar" data-kind="info">Saving…</div>

  <div id="initError" class="hidden fixed top-0 left-0 right-0 z-50 bg-red-700 text-white px-4 py-2 text-sm">
    App init failed. Open the browser console to see the exact error.
  </div>

  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="flex items-center gap-3 md:gap-4 mb-4 md:mb-6">
      <img src="osmak-logo.png" alt="Ospital ng Makati" class="w-12 h-12 md:w-14 md:h-14"/>
      <div class="min-w-0">
        <h1 class="text-xl md:text-2xl font-bold truncate">Just Culture Assessment Tool</h1>
        <p class="text-xs md:text-sm text-neutral-600">Ospital ng Makati</p>
        <p id="caseIdBadge" class="text-xs mt-1 text-emerald-700 font-medium"></p>
        <p id="caseIdHint" class="text-xs text-neutral-500"></p>
      </div>

      <div class="ml-auto no-print flex items-center gap-2 touch-pad">
        <label class="flex items-center gap-2 text-sm">
          <span class="hidden md:inline">Layout:</span>
          <select id="layoutMode" class="border rounded-lg px-2 py-1 input-lg">
            <option value="auto">Auto</option>
            <option value="mobile">Mobile</option>
            <option value="desktop">Desktop</option>
          </select>
        </label>
        <button data-action="new" class="px-3 py-2 rounded-lg bg-green-700 text-white hover:bg-green-800">New</button>
        <button id="btnSave" data-action="save" class="px-3 py-2 rounded-lg bg-green-700 text-white hover:bg-green-800">Save</button>
        <button data-action="print" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Print / PDF</button>
        <button data-action="csv" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Export CSV</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="no-print grid tabbar grid-cols-6 gap-2 mb-4">
      <button data-tab="event" class="tab px-3 py-2 rounded-lg bg-white border shadow-sm font-medium">Event</button>
      <button data-tab="investigation" class="tab px-3 py-2 rounded-lg bg-white border shadow-sm font-medium">Investigation</button>
      <button data-tab="breach" class="tab px-3 py-2 rounded-lg bg-white border shadow-sm font-medium">Breach</button>
      <button data-tab="assessment" class="tab px-3 py-2 rounded-lg bg-white border shadow-sm font-medium">Assessment</button>
      <button data-tab="system" class="tab px-3 py-2 rounded-lg bg-white border shadow-sm font-medium">System</button>
      <button data-tab="report" class="tab px-3 py-2 rounded-lg bg-white border shadow-sm font-medium">Report</button>
    </nav>

    <!-- Previous entries -->
    <section class="no-print mb-4">
      <details class="group">
        <summary class="cursor-pointer select-none px-4 py-2 bg-green-50 border border-green-200 rounded-lg text-green-900 font-semibold">Previous Entries (View / Edit / Delete)</summary>
        <div class="mt-3 p-3 bg-white border rounded-lg">
          <div class="flex items-center gap-2 mb-3">
            <input id="searchBox" type="text" placeholder="Search ID, description, location, division…" class="w-full px-3 py-2 border rounded-lg"/>
            <button data-action="refresh" class="px-3 py-2 rounded-lg bg-neutral-800 text-white">Refresh</button>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-neutral-100 text-neutral-700">
                <tr>
                  <th class="px-2 py-2 text-left">Case ID</th>
                  <th class="px-2 py-2 text-left">Event Date</th>
                  <th class="px-2 py-2 text-left">Description</th>
                  <th class="px-2 py-2 text-left">Division</th>
                  <th class="px-2 py-2 text-left">Breach</th>
                  <th class="px-2 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody id="rowsTable"></tbody>
            </table>
          </div>
        </div>
      </details>
    </section>

    <!-- Cards -->
    <main id="cards" class="space-y-6">
      <!-- EVENT -->
      <section data-panel="event" class="card bg-white border rounded-xl p-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-3 text-emerald-800">Event</h2>
        <div class="grid grid-2 grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-medium mb-2">I. Event Details</h3>
            <label class="block text-sm mb-1">Description</label>
            <textarea id="ev_description" rows="7" class="w-full p-3 border rounded-lg input-lg" placeholder="Describe the event clearly and concisely…"></textarea>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <div>
                <label class="block text-sm mb-1">Location</label>
                <input id="ev_location" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div>
                <label class="block text-sm mb-1">Work Location</label>
                <input id="emp_workLocation" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div>
                <label class="block text-sm mb-1">Event Date</label>
                <input id="ev_eventDate" type="date" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div>
                <label class="block text-sm mb-1">Report Assessment Date</label>
                <input id="ev_reportDate" type="date" class="w-full p-2 border rounded-lg input-lg" />
              </div>
            </div>
          </div>
          <div>
            <h3 class="font-medium mb-2">II. Employee Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">First Name</label>
                <input id="emp_firstName" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div>
                <label class="block text-sm mb-1">Last Name</label>
                <input id="emp_lastName" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div>
                <label class="block text-sm mb-1">Title</label>
                <input id="emp_title" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div>
                <label class="block text-sm mb-1">Phone No.</label>
                <input id="emp_phone" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div>
                <label class="block text-sm mb-1">Employee No.</label>
                <input id="emp_number" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div>
                <label class="block text-sm mb-1">Hire Date</label>
                <input id="emp_hireDate" type="date" class="w-full p-2 border rounded-lg input-lg" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm mb-1">Division</label>
                <input id="emp_division" class="w-full p-2 border rounded-lg input-lg" />
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- INVESTIGATION -->
      <section data-panel="investigation" class="hidden card bg-white border rounded-xl p-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-3 text-emerald-800">Investigation</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">What happened?</label>
            <textarea id="inv_whatHappened" rows="4" class="w-full p-3 border rounded-lg input-lg"></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">What normally happens?</label>
            <textarea id="inv_normal" rows="4" class="w-full p-3 border rounded-lg input-lg"></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">What does procedure require? <span title="If applicable; cite policy or SOP" class="text-xs text-neutral-500">(?)</span></label>
            <textarea id="inv_procedure" rows="4" class="w-full p-3 border rounded-lg input-lg"></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">Why did it happen?</label>
            <textarea id="inv_why" rows="4" class="w-full p-3 border rounded-lg input-lg"></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">How are the risks managed?</label>
            <textarea id="inv_riskMgmt" rows="4" class="w-full p-3 border rounded-lg input-lg"></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">Additional Comments</label>
            <textarea id="inv_comments" rows="4" class="w-full p-3 border rounded-lg input-lg"></textarea>
          </div>
        </div>
      </section>

      <!-- BREACH -->
      <section data-panel="breach" class="hidden card bg-white border rounded-xl p-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-3 text-emerald-800">Breach</h2>
        <fieldset class="grid grid-cols-1 gap-3">
          <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-emerald-50 cursor-pointer">
            <input class="mt-1" type="radio" name="breach" value="duty_harm" />
            <div>
              <div class="font-medium">1) Duty to Avoid Causing Unjustifiable Risk or Harm</div>
              <div class="text-sm text-neutral-600">Did the person put an organizational interest or value in harm's way?</div>
            </div>
          </label>
          <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-emerald-50 cursor-pointer">
            <input class="mt-1" type="radio" name="breach" value="duty_rule" />
            <div>
              <div class="font-medium">2) Duty to Follow Procedural Rules</div>
              <div class="text-sm text-neutral-600">Did the person breach a duty to follow a procedural rule?</div>
            </div>
          </label>
          <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-emerald-50 cursor-pointer">
            <input class="mt-1" type="radio" name="breach" value="duty_outcome" />
            <div>
              <div class="font-medium">3) Duty to Produce Outcomes</div>
              <div class="text-sm text-neutral-600">Did the person breach a duty to produce an outcome?</div>
            </div>
          </label>
          <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-emerald-50 cursor-pointer">
            <input class="mt-1" type="radio" name="breach" value="repetitive" />
            <div>
              <div class="font-medium">4) Repetitive Human Error or At-Risk Behavior</div>
              <div class="text-sm text-neutral-600">Is there a series of human errors or continuing at-risk behavior that make this person an outlier in performance?</div>
            </div>
          </label>
          <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-emerald-50 cursor-pointer">
            <input class="mt-1" type="radio" name="breach" value="no_breach" />
            <div>
              <div class="font-medium">5) No Breach</div>
            </div>
          </label>
        </fieldset>
        <label class="block text-sm mt-4 mb-1">Description</label>
        <textarea id="breach_description" rows="4" class="w-full p-3 border rounded-lg input-lg" placeholder="Add any clarifying notes on the selected breach (optional)"></textarea>
      </section>

      <!-- ASSESSMENT -->
      <section data-panel="assessment" class="hidden card bg-white border rounded-xl p-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-3 text-emerald-800">Assessment</h2>
        <div id="assessmentQuestions" class="space-y-3"></div>
        <div class="mt-4">
          <div class="text-sm text-neutral-600 mb-1">Derived Decision</div>
          <div id="decisionBox" class="border rounded-lg p-3 bg-neutral-50"></div>
        </div>
      </section>

      <!-- SYSTEM -->
      <section data-panel="system" class="hidden card bg-white border rounded-xl p-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-3 text-emerald-800">System</h2>
        <label class="block text-sm mb-1">Does the system appear designed to achieve the results you intend?</label>
        <div class="flex items-center gap-6 mb-3">
          <label class="flex items-center gap-2"><input type="radio" name="sys_ok" value="yes"> <span>Yes</span></label>
          <label class="flex items-center gap-2"><input type="radio" name="sys_ok" value="no"> <span>No — redesign required</span></label>
        </div>
        <div id="sys_prompts" class="hidden mt-2 space-y-2">
          <div class="text-sm text-neutral-600">Guided prompts (fill as relevant):</div>
          <textarea id="sys_staffing" rows="2" class="w-full p-2 border rounded-lg input-lg" placeholder="Staffing"></textarea>
          <textarea id="sys_equipment" rows="2" class="w-full p-2 border rounded-lg input-lg" placeholder="Equipment"></textarea>
          <textarea id="sys_training" rows="2" class="w-full p-2 border rounded-lg input-lg" placeholder="Training / competency"></textarea>
          <textarea id="sys_environment" rows="2" class="w-full p-2 border rounded-lg input-lg" placeholder="Environment / workflow"></textarea>
          <textarea id="sys_it" rows="2" class="w-full p-2 border rounded-lg input-lg" placeholder="IT / EMR / alerts"></textarea>
          <textarea id="sys_policy" rows="2" class="w-full p-2 border rounded-lg input-lg" placeholder="Policy / Procedure (gaps, updates, approvals)"></textarea>
          <label class="block text-sm mt-2">Required Action Plan</label>
          <textarea id="sys_actionPlan" rows="3" class="w-full p-2 border rounded-lg input-lg" placeholder="Describe redesign actions, owner, and timeline"></textarea>
        </div>
      </section>

      <!-- REPORT -->
      <section data-panel="report" class="hidden card bg-white border rounded-xl p-5 shadow-sm">
        <h2 class="text-xl font-semibold mb-3 text-emerald-800">Report</h2>
        <div id="reportContainer" class="space-y-4"></div>
      </section>
    </main>
  </div>

<script>
/* ===== Helpers ===== */
function byId(id){ return document.getElementById(id); }
function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
function toast(msg){ alert(msg); }
function setActiveTab(name){
  var panels = $all('[data-panel]'); for (var i=0;i<panels.length;i++){
    panels[i].classList.toggle('hidden', panels[i].getAttribute('data-panel')!==name);
  }
  var tabs = $all('.tab'); for (var j=0;j<tabs.length;j++){
    tabs[j].classList.toggle('bg-emerald-100', tabs[j].dataset.tab===name);
  }
}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, function(m){ return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]; }); }

/* ===== Busy bar ===== */
var _busyCount = 0;
function setBusy(msg, kind){
  var bar = byId('busyBar'); if(!bar) return;
  bar.textContent = msg || 'Working…';
  bar.setAttribute('data-kind', kind||'info');
  _busyCount++; bar.style.display = 'block';
}
function clearBusy(){
  var bar = byId('busyBar'); if(!bar) return;
  _busyCount = Math.max(0, _busyCount-1);
  if(_busyCount===0){ bar.style.display = 'none'; }
}
function disableSave(disabled){
  var b = byId('btnSave'); if(b){ b.disabled = !!disabled; b.classList.toggle('opacity-60', !!disabled); }
}

/* ===== Config ===== */
var WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzdroioRdkjqpZoOAi70uHw5WP1l9DKHRQeiZAzwwAzg2S-j4g7ae_rFlTHjcgOt32GHw/exec';
var SHEET_NAME = 'Cases';

/* ===== State ===== */
var current = {};
var currentId = null;
function defaultState(){
  return {
    ev:{ description:'', location:'', eventDate:'', reportDate:'',
      employee:{ firstName:'', lastName:'', title:'', phone:'', empNo:'', hireDate:'', division:'', workLocation:'' } },
    inv:{ whatHappened:'', normal:'', procedure:'', why:'', riskMgmt:'', comments:'' },
    breach:{ type:'', description:'' },
    assess:{ answers:{}, decision:'', currentKey:null, path:[], action:'' },
    system:{ ok:'', staffing:'', equipment:'', training:'', environment:'', it:'', policy:'', actionPlan:'' }
  };
}

/* ===== Assessment trees ===== */
var TREES = {
  duty_harm:{ first:'purpose', text:{
      purpose:"Was it the employee's purpose to cause the harm?",
      knowingly:"Did the employee knowingly cause the harm?",
      lesser_evil:"Was the harm justified as the lesser of two evils?",
      substantial:"Did the behavior represent a substantial and unjustifiable risk?",
      conscious_disregard:"Did the employee consciously disregard this substantial and unjustifiable risk?",
      should_have_known:"Given this, should the employee have known they were taking a substantial and unjustifiable risk?",
      choose_behavior:"Did the employee choose the behavior?"
    }, next:function(key,A){
      switch(key){
        case 'purpose': return A.purpose==='yes'?{done:true,decision:'Consider punitive action'}:{next:'knowingly'};
        case 'knowingly': return A.knowingly==='yes'?{next:'lesser_evil'}:{next:'substantial'};
        case 'lesser_evil': return A.lesser_evil==='yes'?{done:true,decision:'Support employee in decision'}:{done:true,decision:'Consider remedial/punitive action'};
        case 'substantial': return A.substantial==='yes'?{next:'conscious_disregard'}:{done:true,decision:'Do not consider employee action'};
        case 'conscious_disregard': return A.conscious_disregard==='yes'?{done:true,decision:'Consider remedial/punitive action'}:{next:'should_have_known'};
        case 'should_have_known': return A.should_have_known==='yes'?{next:'choose_behavior'}:{done:true,decision:'Do not consider employee action'};
        case 'choose_behavior': return A.choose_behavior==='yes'?{done:true,decision:'Coach employee and conduct at-risk behavior investigation'}:{done:true,decision:'Console employee and conduct human error investigation'};
      }
    }},
  duty_rule:{ first:'knew_rule', text:{
      knew_rule:'Was the duty to follow a rule known to the employee?',
      possible:'Was it possible?',
      benefit_outweigh:'Did the benefit outweigh the risks?',
      good_faith:'Did the employee have a good-faith but mistaken belief that the violation was insignificant or justified?'
    }, next:function(key,A){
      switch(key){
        case 'knew_rule': return A.knew_rule==='yes'?{next:'possible'}:{done:true,decision:'Investigate circumstances leading to failure to know of duty'};
        case 'possible': return A.possible==='yes'?{next:'benefit_outweigh'}:{done:true,decision:'Investigate circumstances leading to impossibility'};
        case 'benefit_outweigh': return A.benefit_outweigh==='yes'?{done:true,decision:'Support employee for decision to violate rule'}:{next:'good_faith'};
        case 'good_faith': return A.good_faith==='yes'?{done:true,decision:'Coach employee and conduct at-risk behavior investigation'}:{done:true,decision:'Consider remedial/punitive action'};
      }
    }},
  duty_outcome:{ first:'knew_outcome', text:{
      knew_outcome:'Was the duty to produce an outcome known to the employee?',
      possible:'Was it possible?',
      benefit_outweigh:'Did the benefit outweigh the risks?',
      acceptable_perf:'Is the employee at an acceptable level of performance?'
    }, next:function(key,A){
      switch(key){
        case 'knew_outcome': return A.knew_outcome==='yes'?{next:'possible'}:{done:true,decision:'Investigate circumstances leading to failure to know of duty'};
        case 'possible': return A.possible==='yes'?{next:'benefit_outweigh'}:{done:true,decision:'Investigate circumstances leading to impossibility'};
        case 'benefit_outweigh': return A.benefit_outweigh==='yes'?{done:true,decision:'Support employee in decision'}:{next:'acceptable_perf'};
        case 'acceptable_perf': return A.acceptable_perf==='yes'?{done:true,decision:'Accept outcome'}:{done:true,decision:'Assist employee in producing better outcomes, or consider punitive action'};
      }
    }},
  repetitive:{ first:'system_source', text:{
      system_source:'Does the source of the series of human errors or at-risk behaviors reside within the system?'
    }, next:function(key,A){
      return A.system_source==='yes'?{done:true,decision:'Investigate circumstances leading to system risk'}:{done:true,decision:'Consider remedial/punitive action'};
    }}
};

/* ===== UI sync ===== */
function syncToUI(){
  byId('ev_description').value = current.ev.description;
  byId('ev_location').value = current.ev.location;
  byId('ev_eventDate').value = current.ev.eventDate;
  byId('ev_reportDate').value = current.ev.reportDate;
  byId('emp_firstName').value = current.ev.employee.firstName;
  byId('emp_lastName').value = current.ev.employee.lastName;
  byId('emp_title').value = current.ev.employee.title;
  byId('emp_phone').value = current.ev.employee.phone;
  byId('emp_number').value = current.ev.employee.empNo;
  byId('emp_hireDate').value = current.ev.employee.hireDate;
  byId('emp_division').value = current.ev.employee.division;
  byId('emp_workLocation').value = current.ev.employee.workLocation;

  var br = document.querySelectorAll('input[name="breach"]');
  for (var i=0;i<br.length;i++){ br[i].checked = (br[i].value===current.breach.type); }
  byId('breach_description').value = current.breach.description;

  var so = document.querySelectorAll('input[name="sys_ok"]');
  for (var j=0;j<so.length;j++){ so[j].checked = (so[j].value===current.system.ok); }
  byId('sys_prompts').classList.toggle('hidden', current.system.ok!=='no');
  byId('sys_staffing').value = current.system.staffing;
  byId('sys_equipment').value = current.system.equipment;
  byId('sys_training').value = current.system.training;
  byId('sys_environment').value = current.system.environment;
  byId('sys_it').value = current.system.it;
  byId('sys_policy').value = current.system.policy;
  byId('sys_actionPlan').value = current.system.actionPlan;

  renderAssessment();
  renderReport();
  renderCaseIdBadge();
}
function readFromUI(){
  current.ev.description = byId('ev_description').value.trim();
  current.ev.location = byId('ev_location').value.trim();
  current.ev.eventDate = byId('ev_eventDate').value;
  current.ev.reportDate = byId('ev_reportDate').value;
  var emp = current.ev.employee;
  emp.firstName = byId('emp_firstName').value.trim();
  emp.lastName = byId('emp_lastName').value.trim();
  emp.title = byId('emp_title').value.trim();
  emp.phone = byId('emp_phone').value.trim();
  emp.empNo = byId('emp_number').value.trim();
  emp.hireDate = byId('emp_hireDate').value;
  emp.division = byId('emp_division').value.trim();
  emp.workLocation = byId('emp_workLocation').value.trim();

  var bsel = document.querySelector('input[name="breach"]:checked');
  current.breach.type = bsel ? bsel.value : '';
  current.breach.description = byId('breach_description').value.trim();

  var ssel = document.querySelector('input[name="sys_ok"]:checked');
  current.system.ok = ssel ? ssel.value : '';
  current.system.staffing = byId('sys_staffing').value;
  current.system.equipment = byId('sys_equipment').value;
  current.system.training = byId('sys_training').value;
  current.system.environment = byId('sys_environment').value;
  current.system.it = byId('sys_it').value;
  current.system.policy = byId('sys_policy').value;
  current.system.actionPlan = byId('sys_actionPlan').value;

  renderCaseIdBadge(); // update the "will look like" hint live
}

/* ===== Local preview of the ID prefix (for new cases) ===== */
function breachCodeLocal(t){
  return t==='duty_harm'?'DH':t==='duty_rule'?'PR':t==='duty_outcome'?'DO':t==='repetitive'?'RB':t==='no_breach'?'NB':'NB';
}
function sanitizeLocLocal(s){
  s = (s||'').toUpperCase().replace(/[^A-Z0-9]/g,''); if(!s) s='UNK'; return s.slice(0,6);
}
function yyyymmddLocal(d){
  var dt = d?new Date(d):new Date(); if(isNaN(dt)) dt=new Date();
  var y=dt.getFullYear(), m=('0'+(dt.getMonth()+1)).slice(-2), da=('0'+dt.getDate()).slice(-2);
  return y+''+m+''+da;
}
function renderCaseIdBadge(){
  var badge = byId('caseIdBadge'), hint = byId('caseIdHint');
  if(badge) badge.textContent = currentId ? ('Case ID: ' + currentId) : 'New case (ID assigned on Save)';
  if(hint){
    if(currentId){
      hint.textContent = '';
    }else{
      var prefix = 'JC-' + breachCodeLocal(current.breach.type) + '-' +
                   sanitizeLocLocal(current.ev.location) + '-' +
                   yyyymmddLocal(current.ev.eventDate);
      hint.textContent = 'Will look like: ' + prefix + '-NN';
    }
  }
}

/* ===== Assessment UI ===== */
function startAssessment(){
  var type = current.breach.type;
  current.assess.answers = {};
  current.assess.path = [];
  current.assess.action = '';
  current.assess.currentKey = (TREES[type] && TREES[type].first) ? TREES[type].first : null;
  renderAssessment();
}
function renderAssessment(){
  var panel = byId('assessmentQuestions'); if(!panel) return;
  panel.innerHTML = '';
  var type = current.breach.type;

  if(!type){
    byId('decisionBox').textContent='';
    panel.innerHTML = '<div class="text-sm text-neutral-600">Select a breach first.</div>';
    return;
  }
  if(type==='no_breach'){
    byId('decisionBox').textContent = 'No breach selected → proceed to System Test.';
    panel.innerHTML = '<div class="text-sm text-neutral-600">No further assessment. Proceed to System tab.</div>';
    return;
  }

  for (var i=0;i<(current.assess.path||[]).length;i++){
    var step = current.assess.path[i];
    var block = document.createElement('div');
    block.className = 'flex items-center justify-between border rounded-lg p-3';
    block.innerHTML = '<div class="pr-4">'+step.q+'</div>\
      <div class="flex items-center gap-6">\
        <label class="flex items-center gap-2">\
          <input type="radio" name="ass_prev_'+i+'" data-index="'+i+'" value="yes" '+(step.a==='yes'?'checked':'')+'>\
          <span>Yes</span>\
        </label>\
        <label class="flex items-center gap-2">\
          <input type="radio" name="ass_prev_'+i+'" data-index="'+i+'" value="no" '+(step.a==='no'?'checked':'')+'>\
          <span>No</span>\
        </label>\
      </div>';
    panel.appendChild(block);
  }

  if(!current.assess.currentKey){
    byId('decisionBox').textContent = current.assess.decision || '';
    var actionWrap = document.createElement('div');
    actionWrap.className = 'mt-3';
    actionWrap.innerHTML = '<label class="block text-sm mb-1">Action</label>\
      <textarea id="ass_action" rows="4" class="w-full p-3 border rounded-lg input-lg" placeholder="Document the action to be taken at this endpoint...">'+(current.assess.action||'')+'</textarea>';
    panel.appendChild(actionWrap);
    return;
  }

  var key = current.assess.currentKey;
  var text = TREES[type].text[key];
  var row = document.createElement('div');
  row.className='flex items-center justify-between border rounded-lg p-3';
  row.innerHTML = '<div class="pr-4">'+text+'</div>\
    <div class="flex items-center gap-6">\
      <label class="flex items-center gap-2"><input type="radio" name="step_answer" value="yes"> <span>Yes</span></label>\
      <label class="flex items-center gap-2"><input type="radio" name="step_answer" value="no"> <span>No</span></label>\
    </div>';
  panel.appendChild(row);
}
function handleStepAnswer(val){
  var type = current.breach.type; if(!type) return;
  var key = current.assess.currentKey; if(!key) return;
  var A = current.assess.answers; A[key]=val;
  current.assess.path.push({key:key, q:TREES[type].text[key], a:val});
  var move = TREES[type].next(key, A);
  if(move.done){
    current.assess.currentKey = null;
    current.assess.decision = move.decision;
    byId('assessmentQuestions').innerHTML = '';
    renderAssessment();
    byId('decisionBox').textContent = move.decision;
  }else{
    current.assess.currentKey = move.next;
    renderAssessment();
  }
}
function handlePrevAnswer(index, val){
  var type = current.breach.type; if(!type) return;
  if(!current.assess.path || index<0 || index>=current.assess.path.length) return;
  var changedKey = current.assess.path[index].key;
  current.assess.path[index].a = val;
  current.assess.answers[changedKey] = val;
  var removed = current.assess.path.splice(index+1);
  for (var i=0;i<removed.length;i++){ delete current.assess.answers[removed[i].key]; }
  var move = TREES[type].next(changedKey, current.assess.answers);
  if(move.done){ current.assess.currentKey = null; current.assess.decision = move.decision; }
  else { current.assess.currentKey = move.next; current.assess.decision = ''; }
  renderAssessment();
  byId('decisionBox').textContent = current.assess.decision||'';
}

/* ===== Report ===== */
function renderReport(){
  var c = current, R = byId('reportContainer'); if(!R) return;
  var e = c.ev.employee;
  var labels = {
    duty_harm:'Duty to Avoid Causing Unjustifiable Risk or Harm',
    duty_rule:'Duty to Follow Procedural Rules',
    duty_outcome:'Duty to Produce Outcomes',
    repetitive:'Repetitive Human Error or At-Risk Behavior',
    no_breach:'No Breach'
  };
  var breachLabel = labels[c.breach.type] || '';
  var pathHTML = (c.assess.path && c.assess.path.length) ? (
    '<div class="mt-3"><table class="min-w-full text-sm border">\
      <thead class="bg-neutral-100 text-neutral-700">\
        <tr><th class="px-2 py-1 text-left">Question</th><th class="px-2 py-1 text-left">Answer</th></tr>\
      </thead><tbody>' +
      c.assess.path.map(function(p){ return '<tr class="border-t"><td class="px-2 py-1">'+escapeHTML(p.q)+'</td><td class="px-2 py-1">'+(p.a==='yes'?'Yes':'No')+'</td></tr>'; }).join('') +
    '</tbody></table></div>'
  ) : '';

  R.innerHTML =
  '<section class="border rounded-lg p-4">\
    <h3 class="font-semibold text-emerald-800 mb-2">Header</h3>\
    <div><b>Case ID:</b> '+(currentId || '—')+'</div>\
  </section>\
  <section class="border rounded-lg p-4">\
    <h3 class="font-semibold text-emerald-800 mb-2">Event Details</h3>\
    <div><b>Description:</b> '+escapeHTML(c.ev.description)+'</div>\
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">\
      <div><b>Location:</b> '+escapeHTML(c.ev.location)+'</div>\
      <div><b>Work Location:</b> '+escapeHTML(e.workLocation)+'</div>\
      <div><b>Event Date:</b> '+(c.ev.eventDate||'')+'</div>\
      <div><b>Report Assessment Date:</b> '+(c.ev.reportDate||'')+'</div>\
    </div>\
  </section>\
  <section class="border rounded-lg p-4">\
    <h3 class="font-semibold text-emerald-800 mb-2">Employee</h3>\
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">\
      <div><b>Name:</b> '+escapeHTML(e.firstName)+' '+escapeHTML(e.lastName)+'</div>\
      <div><b>Title:</b> '+escapeHTML(e.title)+'</div>\
      <div><b>Phone:</b> '+escapeHTML(e.phone)+'</div>\
      <div><b>Employee No.:</b> '+escapeHTML(e.empNo)+'</div>\
      <div><b>Hire Date:</b> '+(e.hireDate||'')+'</div>\
      <div><b>Division:</b> '+escapeHTML(e.division)+'</div>\
    </div>\
  </section>\
  <section class="border rounded-lg p-4">\
    <h3 class="font-semibold text-emerald-800 mb-2">Breach</h3>\
    <div><b>Type:</b> '+escapeHTML(breachLabel)+'</div>\
    <div class="mt-1"><b>Description:</b> '+escapeHTML(c.breach.description)+'</div>\
    <div class="mt-2"><b>Assessment Decision:</b> '+escapeHTML(c.assess.decision)+'</div>' +
    pathHTML +
    (c.assess.action ? '<div class="mt-2"><b>Assessment Action:</b><br>'+escapeHTML(c.assess.action)+'</div>' : '') +
  '</section>\
  <section class="border rounded-lg p-4">\
    <h3 class="font-semibold text-emerald-800 mb-2">System</h3>\
    <div><b>System appears designed to achieve intended results?</b> '+(c.system.ok||'')+'</div>' +
    (c.system.ok==='no' ? '\
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">\
        <div><b>Staffing:</b><br>'+escapeHTML(c.system.staffing)+'</div>\
        <div><b>Equipment:</b><br>'+escapeHTML(c.system.equipment)+'</div>\
        <div><b>Training:</b><br>'+escapeHTML(c.system.training)+'</div>\
        <div><b>Environment:</b><br>'+escapeHTML(c.system.environment)+'</div>\
        <div><b>IT:</b><br>'+escapeHTML(c.system.it)+'</div>\
        <div><b>Policy / Procedure:</b><br>'+escapeHTML(c.system.policy)+'</div>\
      </div>\
      <div class="mt-2"><b>Action Plan:</b><br>'+escapeHTML(c.system.actionPlan)+'</div>'
    : '') +
  '</section>';
}

/* ===== CSV ===== */
function flattenCurrent(){
  var c=current, e=c.ev.employee, a=c.assess, s=c.system;
  return {
    id: currentId||'',
    description:c.ev.description, location:c.ev.location, eventDate:c.ev.eventDate, reportDate:c.ev.reportDate,
    firstName:e.firstName, lastName:e.lastName, title:e.title, phone:e.phone, empNo:e.empNo, hireDate:e.hireDate, division:e.division, workLocation:e.workLocation,
    inv_whatHappened:c.inv.whatHappened, inv_normal:c.inv.normal, inv_procedure:c.inv.procedure, inv_why:c.inv.why, inv_riskMgmt:c.inv.riskMgmt, inv_comments:c.inv.comments,
    breach:c.breach.type, breach_desc:c.breach.description,
    decision:a.decision, assessment_action:a.action,
    system_ok:s.ok, system_actionPlan:s.actionPlan, system_policy:s.policy
  };
}
function exportCSV(){
  var flat = flattenCurrent();
  var headers = Object.keys(flat).join(',');
  var values = Object.values(flat).map(function(v){ return '"'+String(v).replace(/"/g,'""')+'"'; }).join(',');
  var blob = new Blob([headers+'\n'+values],{type:'text/csv;charset=utf-8;'});
  var a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='just-culture-case.csv'; a.click();
}

/* ===== Backend API (no preflight) ===== */
async function api(method, payload){
  var res, text;
  try{
    res = await fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify({ method:method, sheet:SHEET_NAME, payload:payload }) });
  }catch(netErr){ throw new Error('Network error contacting backend: '+netErr.message); }
  try{ text = await res.text(); }catch(readErr){ throw new Error('Failed to read backend response: '+readErr.message); }
  var data; try{ data = JSON.parse(text); }catch(e){ throw new Error('Bad JSON from backend (HTTP '+res.status+'): '+text.slice(0,200)); }
  if(!res.ok) throw new Error('HTTP '+res.status+': '+(data && data.error ? data.error : 'Unknown error'));
  if(!data.ok) throw new Error(data.error || 'API error without message');
  return data;
}
async function loadRows(){
  try{
    setBusy('Loading…','info');
    var q = byId('searchBox').value.trim();
    var out = await api('list', { q:q });
    var rows = out.rows || [];
    var tbody = byId('rowsTable'); if(!tbody) return;
    var html = '';
    for(var i=0;i<rows.length;i++){
      var r = rows[i];
      html += '<tr class="border-b">\
        <td class="px-2 py-2">'+r.id+'</td>\
        <td class="px-2 py-2">'+(r.eventDate||'')+'</td>\
        <td class="px-2 py-2">'+escapeHTML(r.description||'')+'</td>\
        <td class="px-2 py-2">'+escapeHTML(r.division||'')+'</td>\
        <td class="px-2 py-2">'+escapeHTML(r.breach||'')+'</td>\
        <td class="px-2 py-2">\
          <button data-action="edit" data-id="'+r.id+'" class="text-emerald-700 mr-2">Edit</button>\
          <button data-action="delete" data-id="'+r.id+'" class="text-red-700">Delete</button>\
        </td></tr>';
    }
    tbody.innerHTML = html;
  }catch(err){
    setBusy('Load failed','error'); setTimeout(clearBusy,1200);
    console.error('List error:', err);
    toast('List refresh failed: '+err.message);
  }finally{
    clearBusy();
  }
}
async function openRow(id){
  try{
    setBusy('Opening…','info');
    var out = await api('get', { id:id });
    current = out.record.data; currentId = out.record.id;
    syncToUI(); setActiveTab('event');
  }catch(err){
    setBusy('Open failed','error'); setTimeout(clearBusy,1200);
    console.error('Open failed:', err); toast('Open failed: '+err.message);
  }finally{
    clearBusy();
  }
}
async function delRow(id){
  if(!confirm('Delete this entry?')) return;
  try{
    setBusy('Deleting…','info');
    await api('delete', { id:id });
    loadRows();
  }catch(err){
    setBusy('Delete failed','error'); setTimeout(clearBusy,1200);
    console.error('Delete failed:', err); toast('Delete failed: '+err.message);
  }finally{
    clearBusy();
  }
}
async function save(){
  readFromUI();
  if(current.breach.type==='no_breach') setActiveTab('system');
  if(current.system.ok==='no' && !current.system.actionPlan.trim()){
    setActiveTab('system'); return toast('Action Plan is required when System Test = No.');
  }
  try{
    setBusy('Saving…','info'); disableSave(true);
    var rec = { id: currentId, data: current };
    var resp = await api('save', rec);
    currentId = resp.id;
    renderCaseIdBadge();
    setBusy('Saved','info'); setTimeout(clearBusy,800);
  }catch(err){
    setBusy('Save failed','error'); setTimeout(clearBusy,1500);
    console.error('Save error:', err); toast('Save failed: '+err.message);
  }finally{
    disableSave(false);
  }
  try{ await loadRows(); }catch(err){ /* handled in loadRows */ }
}

/* ===== Layout mode (auto / mobile / desktop) ===== */
function applyLayoutClass(mode){
  var root = byId('appRoot');
  root.classList.remove('mobile-forced','desktop-forced','mobile-auto');
  if(mode==='mobile'){ root.classList.add('mobile-forced'); }
  else if(mode==='desktop'){ root.classList.add('desktop-forced'); }
  else { root.classList.add('mobile-auto'); }
}
function initLayoutMode(){
  var sel = byId('layoutMode');
  var saved = localStorage.getItem('jc_layout_mode') || 'auto';
  sel.value = saved;
  applyLayoutClass(saved);
  sel.addEventListener('change', function(){
    var m = sel.value;
    localStorage.setItem('jc_layout_mode', m);
    applyLayoutClass(m);
  });
}

/* ===== Delegated UI events ===== */
function wireDelegatedEvents(){
  document.addEventListener('click', function(e){
    var t = e.target;
    if(!t) return;

    // Tabs
    var tabBtn = t.closest ? t.closest('.tab') : null;
    if(tabBtn && tabBtn.dataset && tabBtn.dataset.tab){
      setActiveTab(tabBtn.dataset.tab);
      return;
    }

    // Top actions
    if(t.dataset && t.dataset.action){
      if(t.dataset.action==='new') { current = defaultState(); currentId=null; syncToUI(); renderCaseIdBadge(); return; }
      if(t.dataset.action==='save'){ save(); return; }
      if(t.dataset.action==='print'){ window.print(); return; }
      if(t.dataset.action==='csv'){ exportCSV(); return; }
      if(t.dataset.action==='refresh'){ loadRows(); return; }
      if(t.dataset.action==='edit'){ openRow(t.dataset.id); return; }
      if(t.dataset.action==='delete'){ delRow(t.dataset.id); return; }
    }
  });

  var cards = byId('cards');
  if(cards){
    cards.addEventListener('change', function(e){
      var t = e.target;
      if(!t) return;

      if(t.name==='step_answer'){ handleStepAnswer(t.value); renderReport(); return; }
      if(typeof t.name==='string' && t.name.indexOf('ass_prev_')===0){
        var idx = parseInt(t.getAttribute('data-index')||'-1',10);
        handlePrevAnswer(idx, t.value); renderReport(); return;
      }
      if(t.id==='ass_action'){ current.assess.action = t.value; renderReport(); return; }
      if(t.name==='breach'){ readFromUI(); startAssessment(); renderAssessment(); return; }
      if(t.name==='sys_ok'){ readFromUI(); byId('sys_prompts').classList.toggle('hidden', current.system.ok!=='no'); renderReport(); return; }

      readFromUI(); renderReport();
    });
  }
}

/* ===== Boot ===== */
(function boot(){
  try{
    initLayoutMode();
    wireDelegatedEvents();
    setActiveTab('event');
    current = defaultState();
    syncToUI();
    renderCaseIdBadge();
    loadRows();

    var sb = byId('searchBox');
    if(sb){
      var timer = null;
      sb.addEventListener('input', function(){ clearTimeout(timer); timer = setTimeout(loadRows, 300); });
    }
  }catch(err){
    console.error(err);
    byId('initError').classList.remove('hidden');
  }
})();
</script>
</body>
</html>
